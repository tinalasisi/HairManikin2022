---
title: "Analysis"
author: "Tina Lasisi"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  workflowr::wflow_html:
    toc: yes
    number_sections: yes
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(fs)
library(ggstatsplot)
# knitting to pdf
# rmarkdown::render(input = "analysis/analysis.Rmd", output_format = "pdf_document", output_dir = "output")
F = rprojroot::is_rstudio_project$make_fix_file()
palettedf <- tibble(paletteer::palettes_d_names)
# filter(.data = palettedf, length > 10 & type == "qualitative")
knitr::opts_chunk$set(echo = FALSE, include = TRUE, eval = TRUE, warning = FALSE, message = FALSE, fig.retina = 2, fig.width = 8, fig.height = 6, out.width = "100%")
```


```{r functions, include=FALSE}
# This is a function to save the figures
plot_path = F("output/")
pltsave_func <- function(plot, plot_path, width, height){
  ggsave(
      filename = paste0(deparse(substitute(plot)), ".png"),
      plot = plot, 
      path = plot_path,
      width = width,
      height = height)
  plot(plot)
}
```

```{r df-import, include=FALSE}
# Importing data
df_wetdry <- read_csv(F("data/current/ManikinData_WetDry.csv"), 
    col_types = cols(
      wig = col_factor(levels = c("Nude", 
        "LowCurv", "MidCurv", "HighCurv")), 
      radiation = col_factor(levels = c("off", 
            "on")),
      wet_dry = col_factor(levels = c("dry", 
            "wet")),
      trial = col_factor(levels = c("1", "2", "3"))))

head(df_wetdry)

```

# Preparing data

## Estimating dry heat loss at 30C and solar influx

### Solar influx

Here we calculate solar influx and the temperature corrected heat loss for each experiment. 

Solar influx (difference between heat loss with radiation on and off) is calculated as:

$$Solar\ influx \ (W/m^2) = heatflux_{(radiation)}- heatflux_{(no \ radiation)}$$

```{r df-solar-influx}


df_influx <- df_wetdry %>% 
  pivot_longer(cols = c("heatloss", "resistance", "clo")) %>% 
  filter(name == "heatloss") %>% 
  select(-c(skin_temp, amb_temp, amb_rh)) %>% 
  pivot_wider(names_from = radiation, values_from = value) %>% 
  mutate(influx = off-on) %>% 
  drop_na() %>% 
  select(-name)

df_influx

```

Here we plot the solar influx.

```{r plt-solar-influx}

df_influx %>% 
  ggplot(
    aes(x = wig,
        y = influx,
        fill = trial)) + 
  geom_col(position = position_dodge(width = 0.5)) +
  # ylim(0,200)+
  coord_flip() +
  theme_bw() +
  facet_grid(rows = vars(df_influx$wind), cols = vars(df_influx$wet_dry)) +
  labs(x = "Wig used on manikin", y = "Solar Influx in W/m2") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.y = element_blank()) +
  scale_fill_brewer(type = "qual", palette = 'Dark2',  name = "Trial" )

```

A plot of solar influx shows an outlier in the wet experiments where the heat loss with solar radiation was somehow less than the heat loss without solar radiation. We will exclude this outlier.

```{r}

df_influx <- df_influx %>% 
  mutate(influx = replace(influx, influx<0, NA)) %>% 
  drop_na()

```


### Temperature correction (to 30 C)

For the dry heat loss experiments (measuring dry heat resistance), we had to run some experiments at different temperatures to create a large enough gradient between skin/surface temperature and ambient temperature. The manikin is only able to produce results by measuring heat loss, and at 0.3 m/s wind speed, we found that the straight hair and nude (no hair) conditions led to overheating of the manikin. Subsequently, we had to adjust the temperatures to create a temperature gradient. 

We thus need to bring all the measurements of heat loss to the same temperature. As heat resistance is temperature independent, we can use this to calculate the expected heat loss at various temperatures. We estimate heat loss at 30C with the following calculation. 

$$Heat\ loss (W/m^2)_{(30C\ no\ radiation)} = 5/heat\ resistance_{(no \ radiation)} $$
```{r df-30c-radoff}

df_dry_off <- df_wetdry %>% 
  filter(radiation=="off" & wet_dry == "dry") %>% 
  select(c(wig, wind, wet_dry, resistance, trial))

df_dry_off

df_dry30_off<- df_influx %>% 
  filter(wet_dry == "dry") %>% 
  left_join(., 
            df_dry_off) %>% 
  mutate(heatloss30 = 5/resistance) %>% 
  select(-c(on, off)) %>% 
  rename(off = heatloss30)

df_dry30_off

```



To calculate the heat loss at 30C with radiation, we subtract the solar influx from the temperature corrected heat loss:

$$Heat\ loss (W/m^2)_{(30C\ with\ radiation)}  = Heat\ loss (W/m^2)_{(30C\ no\ radiation)}- solar\ influx(W/m^2) $$

```{r df-30c-radon}

df_dry_on <- df_wetdry %>% 
  filter(radiation=="on" & wet_dry =="dry") %>% 
  select(c(wig, wind, wet_dry, resistance, trial))

df_dry_on


df_dry30<- df_dry30_off %>% 
  mutate(on = off-influx) %>% 
  select(-resistance)

df_dry30

```


```{r df-wet-dry}
df_wetdry_final <- bind_rows(df_dry30, df_influx)

df_wetdry_final

df_long_wetdry_final <- df_wetdry_final %>% 
  pivot_longer(influx:on, names_to = "var", values_to = "heatloss")

df_long_wetdry_final

```


# Exploratory plots

```{r df-summary, include=FALSE}
# means and sd
sum_manikin_df <- df_long_wetdry_final %>% 
  group_by(wig, wind, wet_dry, var) %>% 
  summarise( mean = mean(heatloss), sd = sd(heatloss, na.rm = TRUE),
    n = n()
  )

sum_manikin_df

# n seems wrong?


```

## Solar Influx
```{r plt-solar-influx-error, fig.height=4, fig.width=7}

plt_influx_line <- sum_manikin_df %>% 
    filter(var == "influx") %>% 
  ggplot( aes(x = wind, y = mean, group = wig, color = wig)) + 
    geom_line() +
    geom_point() +
    geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width = 0.2, position=position_dodge(0.05)) +
  facet_grid(cols = vars(wet_dry))+
  theme_classic()
  

pltsave_func(plt_influx_line, plot_path, width = 7, height = 4)

```

## Heat loss
```{r plt-heatloss-error, fig.height=4, fig.width=7}

heatloss_sum_manikin_df <- sum_manikin_df %>% 
  filter(var != "influx") 

plt_heatloss_line <- ggplot(
  heatloss_sum_manikin_df, aes(x = wind, y = mean, group = wig, color = wig)) + 
    geom_line() +
    geom_point() +
    geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width = 0.2, position=position_dodge(0.05)) +
  facet_grid(cols = vars(var), rows = vars(wet_dry)) +
  theme_classic()
  

pltsave_func(plt_heatloss_line, plot_path, width = 7, height = 4)

```


# Analyses

# Analyses

## Solar influx

### Dry

Here, we model the effect of the `wig` variable on `influx` while correcting for `wind`. 
In case of solar influx, having hair will decrease solar influx when the hair is dry. The curvature of hair will decrease more solar influx.

```{r lm-dry-influx}

df_dry <- df_wetdry_final %>% 
  filter(wet_dry == "dry")


model_dry <- lm(influx~wind+wig, data=df_dry)
summary(model_dry)
plot(model_dry)

```


### Wet

Here, we repeat the same modelling process for the wet data.

When the hair is sweaty, having curliest hair would decrease solar influx.
```{r lm-wet-influx}

df <- df_wetdry_final %>% 
  filter(wet_dry == "wet")
df_wet <- df_wetdry_final %>% 
  filter(wet_dry == "wet")
model_wet <- lm(influx~wind+wig, data=df_wet)
model_wet
plot(model_wet)
summary(model_wet)
```


## Heat loss

### Dry

#### Radiation off

Here, we model the effect of the `wig` variable on the `off` (heat loss without radiation) variable while correcting for `wind`. 

when the radiation is off, having straight or curly hair will decrease the heat loss.
```{r lm-dry-heatloss-off}

df <- df_wetdry_final %>% 
  filter(wet_dry == "dry")
df_dry_off <- df_wetdry_final %>% 
  filter(wet_dry == "dry")
df_dry_off ## what are the rows 37-72
model_dry_off<- lm(off~wind+wig, data=df_dry_off[1:36,])
summary(model_dry_off)
```

#### Radiation on

when radiation is on and hair is dry, the heat loss would increase given the presence of hair. The curvature of hair would increase the heat loss.
```{r lm-dry-heatloss-on}

df <- df_wetdry_final %>% 
  filter(wet_dry == "dry")
df_dry_on <- df_wetdry_final %>% 
  filter(wet_dry == "dry")

model_dry_on<- lm(on~wind+wig, data=df_dry_on[1:36,])
summary(model_dry_on)
```

### Wet

#### Radiation off

Here, we model the effect of the `wig` variable on the `off` (heat loss without radiation) variable while correcting for `wind`. 

when the radiation is off, having straight or curly hair will decrease the heat loss.
```{r lm-wet-heatloss-off}

df <- df_wetdry_final %>% 
  filter(wet_dry == "wet")
df_wet_off <- df_wetdry_final %>% 
  filter(wet_dry == "wet")
model_wet_off<- lm(off~wind+wig, data=df_wet_off)
summary(model_wet_off)
```

#### Radiation on

when the radiation is on, having straight or curly hair will decrease the heat loss.
```{r lm-wet-heatloss-on}

df <- df_wetdry_final %>% 
  filter(wet_dry == "wet")
df_wet_on <- df_wetdry_final %>% 
  filter(wet_dry == "wet")
model_wet_on<- lm(on~wind+wig, data=df_wet_on)
summary(model_wet_on)
```



